# Docker Compose file cho Digital Ocean Droplet
# Copy file này lên Droplet tại /opt/meltano-sync/docker-compose.yml
# Và thay YOUR_DOCKERHUB_USERNAME bằng Docker Hub username của bạn

services:
  # SSH Tunnel service (tạo tunnel đến MySQL RDS)
  ssh-tunnel:
    image: alpine:latest
    container_name: meltano-ssh-tunnel
    environment:
      - SSH_HOST=${SSH_HOST}
      - SSH_PORT=${SSH_PORT:-22}
      - SSH_USERNAME=${SSH_USERNAME}
      - MYSQL_RDS_HOST=${MYSQL_RDS_HOST}
      - MYSQL_RDS_PORT=${MYSQL_RDS_PORT:-3306}
      - SSH_KEY_FILE=${SSH_KEY_FILE}
    command: >
      sh -c "
        apk add --no-cache openssh-client socat &&
        mkdir -p /root/.ssh &&
        cp /root/.ssh/key.pem /root/.ssh/key.pem.tmp &&
        chmod 600 /root/.ssh/key.pem.tmp &&
        ssh -i /root/.ssh/key.pem.tmp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -N -L 127.0.0.1:3307:$${MYSQL_RDS_HOST}:$${MYSQL_RDS_PORT} $${SSH_USERNAME}@$${SSH_HOST} &
        sleep 3 &&
        socat TCP-LISTEN:3306,bind=0.0.0.0,reuseaddr,fork TCP:127.0.0.1:3307
      "
    volumes:
      - ./keys/${SSH_KEY_FILE}:/root/.ssh/key.pem:ro
    networks:
      - meltano-network
    restart: unless-stopped

  # Meltano service
  meltano:
    image: YOUR_DOCKERHUB_USERNAME/meltano-sync:latest
    container_name: meltano-sync
    restart: unless-stopped
    environment:
      # MySQL connection (qua SSH tunnel - sử dụng tên service ssh-tunnel)
      - MYSQL_HOST=${MYSQL_HOST:-ssh-tunnel}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      
      # Meltano tap-mysql environment variables
      - TAP_MYSQL_HOST=${MYSQL_HOST:-ssh-tunnel}
      - TAP_MYSQL_PORT=${MYSQL_PORT:-3306}
      - TAP_MYSQL_USER=${MYSQL_USER}
      - TAP_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - TAP_MYSQL_DATABASE=${MYSQL_DATABASE}
      
      # PostgreSQL connection
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DBNAME=${POSTGRES_DBNAME}
      - POSTGRES_DEFAULT_TARGET_SCHEMA=${POSTGRES_DEFAULT_TARGET_SCHEMA:-airbyte_raw}
      
      # Meltano target-postgres environment variables
      - TARGET_POSTGRES_HOST=${POSTGRES_HOST}
      - TARGET_POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - TARGET_POSTGRES_USER=${POSTGRES_USER}
      - TARGET_POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - TARGET_POSTGRES_DBNAME=${POSTGRES_DBNAME}
      - TARGET_POSTGRES_DEFAULT_TARGET_SCHEMA=${POSTGRES_DEFAULT_TARGET_SCHEMA:-airbyte_raw}
    volumes:
      - ./.meltano:/app/.meltano
      - ./meltano.yml:/app/meltano.yml
      - ./transform_stream_name.py:/app/transform_stream_name.py
      - ./transform_datetime.py:/app/transform_datetime.py
    depends_on:
      - ssh-tunnel
    networks:
      - meltano-network

networks:
  meltano-network:
    driver: bridge


